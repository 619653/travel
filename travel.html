<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ—…æ¸¸æ”»ç•¥ç”Ÿæˆå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .markdown-body h3 { color: #ec4899; font-size: 1.125rem; font-weight: bold; margin-top: 1rem; margin-bottom: 0.5rem; }
        .markdown-body p { margin-bottom: 0.75rem; line-height: 1.6; color: #374151; }
        .markdown-body strong { color: #111827; }
        .image-scroll { display: flex; overflow-x: auto; gap: 0.5rem; padding: 0.5rem; background: #f3f4f6; }
        .image-scroll img { height: 16rem; width: auto; border-radius: 0.5rem; flex-shrink: 0; object-fit: cover; cursor: pointer; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-2xl mx-auto p-4">
        
        <!-- æ ‡é¢˜ -->
        <div class="text-center py-6">
            <h1 class="text-3xl font-bold text-pink-500 mb-2">ğŸŒ AI æ—…è¡Œæ—¥è®°</h1>
            <p class="text-gray-500 text-sm">è¾“å…¥ç›®çš„åœ°ï¼Œç”Ÿæˆå°çº¢ä¹¦é£æ ¼æ”»ç•¥</p>
        </div>

        <!-- è¾“å…¥è¡¨å• -->
        <div class="bg-white rounded-2xl shadow-sm p-4 mb-6 sticky top-2 z-10">
            <div class="flex gap-2 mb-2">
                <input type="text" id="dest" placeholder="å»å“ªå„¿ï¼Ÿå¦‚ï¼šè‹å·" 
                    class="flex-1 p-3 border rounded-lg text-sm">
                <select id="days" class="p-3 border rounded-lg text-sm w-24">
                    <option value="2">2å¤©</option>
                    <option value="3" selected>3å¤©</option>
                    <option value="5">5å¤©</option>
                </select>
            </div>
            <input type="text" id="style" placeholder="åå¥½ï¼šç¾é£Ÿ/æ‹ç…§/äº²å­..." 
                class="w-full p-3 border rounded-lg text-sm mb-3">
            <button onclick="generate()" id="btn"
                class="w-full bg-gradient-to-r from-pink-500 to-red-500 text-white font-bold py-3 rounded-xl">
                âœ¨ ç”Ÿæˆæ”»ç•¥
            </button>
        </div>

        <!-- åŠ è½½ä¸­ -->
        <div id="loading" class="hidden text-center py-10">
            <div class="animate-spin text-4xl mb-2">ğŸ“</div>
            <p class="text-gray-400 text-sm">AIæ­£åœ¨å†™æ”»ç•¥ï¼Œçº¦éœ€10-20ç§’...</p>
        </div>

        <!-- ç»“æœå±•ç¤º -->
        <div id="result" class="hidden bg-white rounded-2xl shadow-lg overflow-hidden mb-20">
            
            <!-- å›¾ç‰‡åŒº -->
            <div class="image-scroll" id="gallery"></div>

            <!-- å†…å®¹åŒº -->
            <div class="p-5">
                <div id="content" class="markdown-body text-sm"></div>
                
                <!-- æ“ä½œæŒ‰é’® -->
                <div class="flex gap-2 mt-6 pt-4 border-t">
                    <button onclick="copyText()" class="flex-1 bg-gray-100 py-2 rounded-lg text-sm font-medium hover:bg-gray-200">
                        ğŸ“‹ å¤åˆ¶æ–‡æ¡ˆ
                    </button>
                    <button onclick="window.print()" class="flex-1 bg-gray-100 py-2 rounded-lg text-sm font-medium hover:bg-gray-200">
                        ğŸ–¨ï¸ æ‰“å°/ä¿å­˜PDF
                    </button>
                </div>

                <!-- åˆ†äº«é“¾æ¥ -->
                <div class="mt-4 bg-yellow-50 p-3 rounded-lg text-xs text-yellow-800 break-all">
                    <span class="font-bold">åˆ†äº«é“¾æ¥ï¼š</span><span id="shareUrl"></span>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // ğŸ”´ æ”¹è¿™é‡Œç¬¬1å¤„ï¼šä½ çš„ Project URLï¼ˆä»æˆªå›¾çœ‹æ˜¯è¿™ä¸ªï¼‰
        const SUPABASE_URL = 'https://xszcsjwvyajxjyawtuqv.supabase.co'
        
        // ğŸ”´ æ”¹è¿™é‡Œç¬¬2å¤„ï¼šä½ çš„ Publishable Keyï¼ˆä» API Keys é¡µé¢å¤åˆ¶å®Œæ•´çš„ sb_publishable_...ï¼‰
        const SUPABASE_KEY = 'sb_publishable_4_e4kSOCkPEA4LaQa48IPQ_91gV3x4e'
        
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

        // è§£æ Coze çš„ç‰¹æ®Šæ ¼å¼ï¼ˆå›¾ç‰‡æ•°ç»„ + Markdownï¼‰
        function parseContent(raw) {
            const imgMatch = raw.match(/\["(https:\/\/[^"]+)"\]/)
            const images = imgMatch ? [imgMatch[1]] : []
            const text = raw.replace(/\[.*?\]/, '').trim()
            return { images, text }
        }

        async function generate() {
            const dest = document.getElementById('dest').value
            if (!dest) return alert('è¯·è¾“å…¥ç›®çš„åœ°')
            
            document.getElementById('loading').classList.remove('hidden')
            document.getElementById('result').classList.add('hidden')
            document.getElementById('btn').disabled = true
            document.getElementById('btn').textContent = 'ç”Ÿæˆä¸­...'
            
            try {
                const { data, error } = await supabase.functions.invoke('travel-agent', {
                    body: {
                        destination: dest,
                        days: document.getElementById('days').value,
                        style: document.getElementById('style').value
                    }
                })
                
                if (error) throw error
                
                const parsed = parseContent(data.content)
                
                const gallery = document.getElementById('gallery')
                if (parsed.images.length > 0) {
                    gallery.innerHTML = parsed.images.map(url => 
                        `<img src="${url}" onclick="window.open('${url}')">`
                    ).join('')
                    gallery.style.display = 'flex'
                } else {
                    gallery.style.display = 'none'
                }
                
                document.getElementById('content').innerHTML = marked.parse(parsed.text)
                
                const shareUrl = `${window.location.origin}${window.location.pathname}?id=${data.share_id}`
                document.getElementById('shareUrl').textContent = shareUrl
                window.currentText = parsed.text
                
                document.getElementById('result').classList.remove('hidden')
                
            } catch (err) {
                console.error(err)
                alert('ç”Ÿæˆå¤±è´¥ï¼š' + (err.message || 'è¯·æ£€æŸ¥ç½‘ç»œ'))
            } finally {
                document.getElementById('loading').classList.add('hidden')
                document.getElementById('btn').disabled = false
                document.getElementById('btn').textContent = 'âœ¨ ç”Ÿæˆæ”»ç•¥'
            }
        }

        function copyText() {
            if (window.currentText) {
                navigator.clipboard.writeText(window.currentText)
                alert('æ”»ç•¥å·²å¤åˆ¶ï¼å¯ä»¥å»å°çº¢ä¹¦/æœ‹å‹åœˆç²˜è´´äº†~')
            }
        }

        window.onload = async () => {
            const id = new URLSearchParams(location.search).get('id')
            if (id) {
                const { data } = await supabase.from('travel_plans').select('*').eq('share_id', id).single()
                if (data) {
                    const parsed = parseContent(data.content)
                    document.getElementById('gallery').innerHTML = parsed.images.map(url => 
                        `<img src="${url}">`
                    ).join('')
                    document.getElementById('content').innerHTML = marked.parse(parsed.text)
                    document.getElementById('result').classList.remove('hidden')
                    document.getElementById('dest').value = data.destination || ''
                }
            }
        }

        window.generate = generate
        window.copyText = copyText
    </script>
</body>
</html>